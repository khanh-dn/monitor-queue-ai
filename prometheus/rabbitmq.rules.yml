groups:
  - name: rabbitmq-recording-and-alerts
    interval: 30s
    rules:
      ### === Recording Rules: GÃ¡n nhÃ£n service cho cÃ¡c queue ===
      - record: rabbitmq_queue_messages_ready_with_service
        expr: label_replace(rabbitmq_queue_messages_ready, "service", "$1", "queue", "^([a-zA-Z0-9]+)[_.].*")

      - record: rabbitmq_queue_messages_unack_with_service
        expr: label_replace(rabbitmq_queue_messages_unacknowledged, "service", "$1", "queue", "^([a-zA-Z0-9]+)[_.].*")

      - record: rabbitmq_queue_messages_total_with_service
        expr: label_replace(rabbitmq_queue_messages, "service", "$1", "queue", "^([a-zA-Z0-9]+)[_.].*")

      - record: rabbitmq_queue_consumers_with_service
        expr: label_replace(rabbitmq_queue_consumers, "service", "$1", "queue", "^([a-zA-Z0-9]+)[_.].*")

      - record: rabbitmq_service_messages_ready_sum
        expr: sum by (service) (rabbitmq_queue_messages_ready_with_service)

      - record: rabbitmq_service_messages_unack_sum
        expr: sum by (service) (rabbitmq_queue_messages_unack_with_service)

      - record: rabbitmq_service_consumers_sum
        expr: sum by (service) (rabbitmq_queue_consumers_with_service)

      - record: rabbitmq_service_messages_total_sum
        expr: sum by (service) (rabbitmq_queue_messages_total_with_service)

      ### === Alerting Rules: Cáº£nh bÃ¡o cho cÃ¡c queue ===

      - alert: ServiceMessageWarning
        expr: rabbitmq_service_messages_total_sum > 100
        for: 15s
        labels:
          severity: warning
        annotations:
          summary: "âš ï¸ [WARNING] {{ $labels.service }} message count high"
          description: |
            **âš ï¸ Service:** `{{ $labels.service }}`
            **ğŸ“Š Messages Total:** `{{ $value }}`
            **â° Level:** `Warning`
            **ğŸ” Alert:** Total messages in queue vÆ°á»£t ngÆ°á»¡ng 100.

      - alert: ServiceMessageCritical
        expr: rabbitmq_service_messages_total_sum > 200
        for: 15s
        labels:
          severity: critical
        annotations:
          summary: "ğŸš¨ [CRITICAL] {{ $labels.service }} message count too high"
          description: |
            **ğŸš¨ Service:** `{{ $labels.service }}`
            **ğŸ“Š Messages Total:** `{{ $value }}`
            **â° Level:** `Critical`
            **ğŸ” Alert:** Total messages in queue vÆ°á»£t ngÆ°á»¡ng 200.

      - alert: ServiceReadyWarning
        expr: rabbitmq_service_messages_ready_sum > 100
        for: 15s
        labels:
          severity: warning
        annotations:
          summary: "âš ï¸ [WARNING] {{ $labels.service }} backlog cao"
          description: |
            **âš ï¸ Service:** `{{ $labels.service }}`
            **ğŸ“¦ Messages Ready:** `{{ $value }}`
            **â° Level:** `Warning`
            **ğŸ•’ Alert:** Messages chÆ°a xá»­ lÃ½ Ä‘ang tÄƒng.

      - alert: ServiceReadyCritical
        expr: rabbitmq_service_messages_ready_sum > 200
        for: 15s
        labels:
          severity: critical
        annotations:
          summary: "ğŸ”¥ [CRITICAL] {{ $labels.service }} backlog quÃ¡ cao"
          description: |
            **ğŸ”¥ Service:** `{{ $labels.service }}`
            **ğŸ“¦ Messages Ready:** `{{ $value }}`
            **â° Level:** `Critical`
            **ğŸ•’ Alert:** Messages chÆ°a xá»­ lÃ½ vÆ°á»£t ngÆ°á»¡ng nguy hiá»ƒm.

      - alert: ServiceUnackCritical
        expr: rabbitmq_service_messages_unack_sum > 10
        for: 15s
        labels:
          severity: critical
        annotations:
          summary: "ğŸ”´ [CRITICAL] {{ $labels.service }} cÃ³ nhiá»u messages chÆ°a xá»­ lÃ½"
          description: |
            **ğŸ”´ Service:** `{{ $labels.service }}`
            **â›” Messages Unacknowledged:** `{{ $value }}`
            **â° Level:** `Critical`
            **ğŸ” Alert:** Messages Ä‘ang chá» ack nhiá»u báº¥t thÆ°á»ng.

      - alert: ServiceNoConsumer
        expr: rabbitmq_service_consumers_sum < 1
        for: 15s
        labels:
          severity: emergency
        annotations:
          summary: "ğŸ†˜ [EMERGENCY] {{ $labels.service }} khÃ´ng cÃ³ consumer"
          description: |
            **ğŸ†˜ Service:** `{{ $labels.service }}`
            **ğŸ‘¤ Consumers:** `0`
            **â° Level:** `Emergency`
            **ğŸš« Alert:** KhÃ´ng cÃ³ consumer nÃ o Ä‘ang káº¿t ná»‘i hoáº·c xá»­ lÃ½ queue.
